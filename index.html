<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>ARSIP UMPAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif}
body{margin:0;background:#f2f4f7}
header{
  position:fixed;top:0;left:0;right:0;
  background:#1565c0;color:#fff;
  height:60px;display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:700;z-index:1000
}
.back-btn{
  position:absolute;left:12px;
  background:rgba(255,255,255,.2);
  border:none;color:#fff;
  padding:8px 12px;border-radius:10px;cursor:pointer
}
.search-box{
  position:fixed;top:60px;left:0;right:0;
  background:#fff;padding:12px;z-index:900;
  box-shadow:0 4px 10px rgba(0,0,0,.1)
}
.search-box input{
  width:100%;padding:12px 14px;
  border-radius:14px;border:1px solid #ccc;font-size:15px
}
.info{margin-top:130px;text-align:center;font-size:13px;color:#666}
.container{padding:14px;display:grid;gap:16px}
.card{
  background:#fff;border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
  overflow:hidden
}
.card-header{
  padding:14px 16px;
  background:#e3f2fd;
  font-weight:700;color:#0d47a1
}
.card-body{padding:16px;font-size:14px}
.card-body div{margin-bottom:6px}
.card-body span{font-weight:600}
.action{display:flex;gap:12px;margin-top:14px}
.btn{
  flex:1;border:none;border-radius:14px;
  padding:12px;font-weight:700;
  color:#fff;cursor:pointer
}
.open{background:#1e88e5}
.download{background:#2e7d32}
</style>
</head>

<body>

<header>
  <button class="back-btn"
    onclick="location.href='https://rikoantah.github.io/Web-Utama-UMPAR/'">
    ‚Üê Back
  </button>
  ARSIP UMPAR
</header>

<div class="search-box">
  <input id="search" placeholder="üîç Cari nama pegawai (scan semua arsip)">
</div>

<div class="info" id="info">Memuat 50 arsip terakhir...</div>
<div class="container" id="list"></div>

<script>
/* ===== KONFIGURASI ===== */
const SUPABASE_URL = "https://xmbsrxkhatebzsqeyxms.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtYnNyeGtoYXRlYnpzcWV5eG1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTU4NjYsImV4cCI6MjA4NjQ5MTg2Nn0.TJCPXhSm_XrIXIl0BgYn3LaF5O7j5zhfqghJUgJSy88";
const BUCKET = "Arsip RSDS";
const PAGE_SIZE = 100;
const DEFAULT_SHOW = 50;

/* ===== INIT ===== */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const listEl = document.getElementById("list");
const infoEl = document.getElementById("info");
const searchEl = document.getElementById("search");

/* ===== DOWNLOAD ===== */
async function downloadLangsung(name){
  const { data } = await sb.storage
    .from(BUCKET)
    .createSignedUrl(name,60,{download:true});
  const a=document.createElement("a");
  a.href=data.signedUrl;a.download=name;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
}

/* ===== RENDER ===== */
function renderCard(f){
  const p=f.name.replace(".pdf","").split("-");
  const nama=p[0]||"-";
  const nip=p[1]||"-";
  const jenis=p[2]||"-";

  const { data:url } = sb.storage.from(BUCKET).getPublicUrl(f.name);

  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
    <div class="card-header">${nama}</div>
    <div class="card-body">
      <div><span>NIP:</span> ${nip}</div>
      <div><span>Jenis:</span> ${jenis}</div>
      <div><span>Upload:</span> ${new Date(f.created_at).toLocaleString("id-ID")}</div>
      <div class="action">
        <button class="btn open"
          onclick="window.open('${url.publicUrl}','_blank')">üìÑ Buka</button>
        <button class="btn download"
          onclick="downloadLangsung('${f.name}')">‚¨áÔ∏è Download</button>
      </div>
    </div>`;
  listEl.appendChild(c);
}

/* ===== MODE DEFAULT: 50 PALING TERAKHIR MASUK STORAGE ===== */
async function loadTerakhir(){
  let offset = 0;
  let semua = [];

  while (semua.length < DEFAULT_SHOW) {
    const { data } = await sb.storage
      .from(BUCKET)
      .list("", { limit: PAGE_SIZE, offset });

    if (!data || !data.length) break;

    semua = semua.concat(data);
    if (data.length < PAGE_SIZE) break;
    offset += PAGE_SIZE;
  }

  const sorted = semua
    .filter(f => f.name.endsWith(".pdf"))
    .sort((a,b)=> new Date(b.created_at) - new Date(a.created_at))
    .slice(0, DEFAULT_SHOW);

  listEl.innerHTML="";
  sorted.forEach(renderCard);
  infoEl.textContent = `Menampilkan ${sorted.length} arsip terakhir (berdasarkan waktu upload)`;
}

/* ===== SEARCH: SCAN SEMUA FILE ===== */
let timer;
searchEl.addEventListener("input",()=>{
  clearTimeout(timer);
  timer=setTimeout(()=>cari(searchEl.value.trim().toLowerCase()),500);
});

async function cari(keyword){
  if(keyword.length<2){
    loadTerakhir();
    return;
  }

  listEl.innerHTML="";
  infoEl.textContent="Mencari di seluruh arsip...";

  let offset=0, hasil=[];

  while(true){
    const { data } = await sb.storage
      .from(BUCKET)
      .list("",{limit:PAGE_SIZE,offset});

    if(!data || !data.length) break;

    hasil = hasil.concat(
      data.filter(f=>f.name.toLowerCase().includes(keyword))
    );

    if(data.length<PAGE_SIZE) break;
    offset+=PAGE_SIZE;
  }

  hasil.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  hasil.forEach(renderCard);

  infoEl.textContent = hasil.length
    ? `Ditemukan ${hasil.length} arsip`
    : "Tidak ditemukan";
}

/* ===== START ===== */
loadTerakhir();
</script>

</body>
</html>
